<!DOCTYPE html>
<html lang="zh">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<link rel="stylesheet" type="text/css" href="http://cdn.amazeui.org/amazeui/2.2.1/css/amazeui.min.css">
	<style>
		body {
  margin: 50px;
  width: 600px; }

.stack * {
  display: block; }

.flow * {
  display: inline; }

/*# sourceMappingURL=style.css.map */

	</style>
</head>
<body id="item-0">
	<input id="item-1" type="button" class="am-btn am-btn-primary" value="button1" />
<div id="item-2" class="stack"><input id="item-3" type="button" class="am-btn am-btn-primary" value="change background" />
<div class="am-form"><textarea id="item-4">default</textarea></div></div>
<img id="item-5" src="http://7jpqbr.com1.z0.glb.clouddn.com/bw-2014-06-19.jpg" alt=""/>
<input id="item-6" class="am-form-field" type="text" value="http://7jpqbr.com1.z0.glb.clouddn.com/bw-2014-06-19.jpg"/>
<input id="item-7" class="am-form-field" type="text" value="textline"/>
	<script>
		var websocket = 
(function configureWebSocket(){
	var wsUrl = "ws://localhost/";

	var websocket = new WebSocket(wsUrl);
	websocket.onopen = function(evt){
		console.log("Connected.");
	};
	websocket.onmessage = function(evt){
		console.log(evt.data);
		handleMessage(evt.data);
	};
	websocket.onclose = function(evt){
		console.log("Closed.");
	};
	return websocket;
})();

function sync(obj){
	var value = {value: obj.value};
	websocket.send("sync:" + getId(obj) + "->" + JSON.stringify(value));
}

function addEvents(obj, events){
	for(i in events){
		(function(){
			var type = events[i];
			obj.addEventListener(type, function(){
				websocket.send(type + ":" + getId(this));
			});
		})();
	}
}

function getId(obj){
	return obj.id.match(/item-(\d+)/)[1];
}

(function addSyncListener(){
	var inputs = document.getElementsByTagName('input');
	for(var i=0; i<inputs.length; i++){
		inputs[i].addEventListener('input', function(){
			sync(this);
			websocket.send("input:" + getId(this));
		});
	}
	var inputs = document.getElementsByTagName('textarea');
	for(var i=0; i<inputs.length; i++){
		inputs[i].addEventListener('input', function(){
			sync(this);
			websocket.send("input:" + getId(this));
		});
	}
})();

function handleMessage(msg){
	var match_data = msg.match(/(.+?):(\d+)(?:->)?(.+)?/);
	var command = match_data[1];
	var target = document.getElementById('item-' + match_data[2]);
	var data = JSON.parse(match_data[3]);
	switch (command){
		case 'sync':
			target.properties = data;
			if(data.value != undefined && data.value != null)	target.value = data.value;
			if(data.style != undefined && data.style != null)	target.style.cssText = data.style;
			if(data.src != undefined && data.src != null)	target.src = data.src;
			break;
		case 'add_event':
			addEvents(target, data);
			break;
	}
}
	</script>
</body>
</html>